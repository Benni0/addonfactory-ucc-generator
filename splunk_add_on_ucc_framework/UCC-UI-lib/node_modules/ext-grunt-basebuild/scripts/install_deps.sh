#! /bin/bash -x

# This script is called from npm to install various python packages

host=`hostname`
echo "host: $host"

pip_cmd="pip"

# Hack to workaround pip version issues on app-bamboo builders
if [[ -e /usr/local/bin/pip8.0.2 ]]; then
  pip_cmd="/usr/local/bin/pip8.0.2"
fi

{
    cmd="$pip_cmd -V"
    $cmd

    if [ -z "$1" ]; then
        echo "Install latest artifactory_tool" 
        cmd="$pip_cmd install --index-url https://repo.splunk.com/artifactory/api/pypi/pypi-local/simple --pre artifactory_tool --trusted-host repo.splunk.com -t pypi_modules"
        $cmd
    else
        echo "Install artifactory_tool version $1"
        cmd="$pip_cmd install --index-url https://repo.splunk.com/artifactory/api/pypi/pypi-local/simple --pre artifactory_tool==$1 --trusted-host repo.splunk.com -t pypi_modules"
        $cmd
    fi

    cmd="$pip_cmd install artifactory -t pypi_modules/artifactory_tool"
    $cmd

}||{
    #Installation failed. Use local version
    :
}
